- name: Launch new instance
  ec2:
    region        : "{{ region }}"
    zone          : "{{ zone }}"
    keypair       : "{{ keypair }}"
    image         : "{{ ami_id }}"
    group_id      : "{{ security_groups }}"
    instance_type : "{{ instance_type }}"
    vpc_subnet_id : "{{ vpc_subnet_id }}"
    instance_tags :
      Name        : "{{ instance_name }}"
    assign_public_ip : yes
    wait          : yes
  register: ec2

- name: Add new instances to host group
  add_host:
    name             : "{{ item.public_dns_name }}"
    groups           : "{{ instance_name }}"
    ec2_id           : "{{ item.id }}"
    ansible_ssh_user : "{{ instance_user }}"
    ansible_ssh_private_key_file : "~/.ssh/{{ keypair }}"
  with_items: "{{ ec2.instances }}"

- set_fact: ec2_new_ami_id="{{ item.id }}"
  with_items: "{{ ec2.instances }}"

- name: Wait for ssh server to be running
  wait_for: host={{ item.public_dns_name }} port=22 search_regex=OpenSSH
  with_items: "{{ ec2.instances }}"

- name: Accept new ssh fingerprints
  shell: ssh-keyscan -H {{ item.public_dns_name }} >> ~/.ssh/known_hosts
  with_items: '{{ ec2.instances }}'
